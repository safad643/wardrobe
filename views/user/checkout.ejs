<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Enhanced Checkout</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
             * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', sans-serif;
            }
    
            body {
                background: #f5f6f8;
                padding: 2rem;
            }
    
            .checkout-container {
                max-width: 100%;
                padding: 1rem;
                margin: 0;
            }
    
            .checkout-grid {
                display: grid;
                grid-template-columns: 1fr 500px;
                gap: 1.5rem;
                max-width: 100%;
            }
    
            .checkout-left {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                width: 100%;
                min-width: 0;
            }
    
            .checkout-right {
                position: sticky;
                top: 2rem;
                height: fit-content;
                width: 500px;
            }
    
            .checkout-section {
                width: 100%;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.1);
                padding: 1.5rem;
                margin: 0;
            }
    
            .checkout-section h2 {
                margin-bottom: 1.5rem;
                color: #2c3e50;
                font-size: 1.5rem;
            }
    
            .address-card {
                border: 1px solid #e0e0e0;
                padding: 1.5rem;
                margin-bottom: 1rem;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }
    
            .selected-address {
                border-color: #2874f0;
                background: #f0f8ff;
            }
    
            .add-address-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
    
            .modal-content {
                background: white;
                width: 500px;
                padding: 2rem;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                border-radius: 8px;
                animation: modalFade 0.3s ease;
            }
    
            .payment-option {
                margin-bottom: 1rem;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 1rem;
                cursor: pointer;
            }
    
            .payment-fields {
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease-out;
                padding-left: 0;
            }
    
            .payment-option.active {
                border-color: #2874f0;
                background: #f0f8ff;
            }
    
            .payment-option.active .payment-fields {
                max-height: 200px;
                padding: 1rem 0;
                margin-top: 1rem;
            }
    
            .order-items {
                margin-bottom: 2rem;
            }
    
            .order-item {
                display: flex;
                gap: 1.8rem;
                padding: 1.8rem;
                border-bottom: 1px solid #eee;
                position: relative;
            }
    
            .product-image {
                width: 120px;
                height: 120px;
                object-fit: cover;
                margin-right: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
    
            .order-summary {
                background: #f8f9fa;
                padding: 1.5rem;
                border-radius: 8px;
            }
    
            .summary-item {
                display: flex;
                justify-content: space-between;
                padding: 0.8rem 0;
                color: #666;
                font-size: 1rem;
                border-bottom: 1px solid #eee;
            }
    
            .summary-item:last-child {
                border-bottom: none;
            }
    
            .summary-item.total {
                font-size: 1.2rem;
                font-weight: 600;
                color: #2c3e50;
                border-top: 2px solid #eee;
                margin-top: 0.5rem;
                padding-top: 1rem;
                border-bottom: none;
            }
    
            .amount {
                font-weight: 500;
            }
    
            .action-btns {
                margin-top: 2rem;
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
            }
    
            .btn {
                padding: 12px 24px;
                background: #2874f0;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background 0.2s;
            }
    
            .btn:hover {
                background: #1a5bbf;
            }
    
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
    
            @keyframes modalFade {
                from { opacity: 0; transform: translate(-50%, -40%); }
                to { opacity: 1; transform: translate(-50%, -50%); }
            }
               /* Improved address card styling */
        .address-card {
            position: relative;
            padding: 1.5rem;
            margin: 1rem 0;
            background: #f9f9f9;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    
        .address-card p {
            margin: 0;
            line-height: 1.8;
            color: #444;
            font-size: 0.95rem;
        }
    
        .address-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.7rem;
        }
    
        .btn-icon {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 0.3rem;
            transition: color 0.3s ease;
        }
    
        .btn-icon:hover {
            color: var(--primary);
        }
    
        /* Responsive grid adjustments */
        .address-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
    
            .form-input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                margin-top: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            }
    
            .form-input:focus {
                border-color: #2874f0;
                box-shadow: 0 0 0 3px rgba(40, 116, 240, 0.1);
                outline: none;
            }
    
            .form-group {
                margin-bottom: 1.5rem;
            }
    
            .half-width {
                width: calc(50% - 0.5rem);
            }
    
            .full-width {
                width: 100%;
            }
    
            .edit-icon {
                position: absolute;
                top: 1rem;
                right: 1rem;
                color: #2874f0;
                cursor: pointer;
                background: rgba(255,255,255,0.9);
                padding: 5px;
                border-radius: 50%;
            }
    
            .payment-fields input {
                margin-top: 1rem;
            }
    
            .modal-content h2 {
                margin-bottom: 2rem;
                color: #2c3e50;
            }
    
            .address-card {
                position: relative;
                padding-right: 2.5rem;
            }
    
            /* Enhanced payment option styling */
            .payment-option {
                position: relative;
            }
    
            .payment-option label {
                display: flex;
                align-items: center;
                gap: 1rem;
                cursor: pointer;
            }
    
            .payment-option input[type="radio"] {
                width: 20px;
                height: 20px;
                accent-color: #2874f0;
            }
            .error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: none;
}

.form-group.invalid .form-input {
    border-color: #dc3545;
}

.form-group.invalid .error-message {
    display: block;
}
.quantity-control {
    display: inline-flex;
    align-items: center;
    gap: 0.8rem;
    margin-top: 0.5rem;
    background: #f8f9fa;
    padding: 0.3rem 0.3rem 0.3rem 0.3rem;
    border-radius: 25px;
    width: fit-content;
}

.qty-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid #2874f0;
    background: white;
    color: #2874f0;
    font-size: 1rem;
    cursor: pointer;
    color: #ddd;
    font-size: 20px;
    transition: color 0.2s ease-in-out;
}

.qty-btn:hover {
    background: #2874f0;
    color: white;
}

.rating-text {
    color: #666;
    font-size: 14px;
}
.pagetile{
	cursor: pointer;
}
.sort-filter {
    margin-bottom: 15px;
}

.sort-select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
}

.fix {
    display: flex;
    align-items: center;
}

.pro-price {
    color: #c87065;
    font-size: 18px;
    font-weight: 700;
    line-height: 28px;
    display: inline-block;
    vertical-align: middle;
}

.original-price {
    margin-left: 10px;
    text-decoration: line-through;
    color: #999;
    font-size: 14px;
    display: inline-block;
    vertical-align: middle;
    line-height: 28px;
}

.pro-rating {
    margin-left: auto;
}

.wishlist-icon {
    position: relative;
    z-index: 2;
}

.wishlist-icon i {
    transition: all 0.3s ease;
}

.wishlist-icon.active i {
    color: #ff4d94;
}

.wishlist-icon i.zmdi-favorite {
    color: #ff4d94;
}

/* Animation for heart icon */
@keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.wishlist-icon.animate i {
    animation: heartPop 0.3s ease;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item.total {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    border-top: 2px solid #eee;
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-bottom: none;
}

.amount {
    font-weight: 500;
}

/* Place Order Button */
.btn.full-width {
    margin-top: 1.5rem;
    padding: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
    gap: 0.8rem;
}

/* Remove arrows from number input */
.qty-input::-webkit-outer-spin-button,
.qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.qty-input {
    -moz-appearance: textfield;
}

/* Animation styles for smooth removal */
.order-item {
    transition: all 0.3s ease;
}

.order-item.removing {
    opacity: 0;
    transform: translateX(100px);
    height: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
}

.delete-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    font-size: 1rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
}

.delete-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}

.out-of-stock-message {
    color: #dc3545;
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: rgba(220, 53, 69, 0.1);
    border-radius: 4px;
    text-align: center;
}
</style>
    </head>
<body>
    <div class="checkout-container">
        <div class="checkout-grid">
            <!-- Left Column: Address and Payment -->
            <div class="checkout-left">
                <!-- Address Section -->
                <div class="checkout-section" id="addressSection">
                    <h2>Delivery Address</h2>
                    <div class="address-grid">
                        <% addresses.forEach((address, index) => { %>
                            <div class="address-card <%= index === 0 ? 'selected-address' : '' %>" 
                                 data-address-id="<%= address.id %>" 
                                 onclick="selectAddress(this, '<%= address._id %>')">
                                <i class="fas fa-edit edit-icon" onclick="showEditModal(event, '<%= address._id %>')"></i>
                                <h3><%= address.street %></h3>
                                <p><%= address.city %>, <%= address.state %></p>
                                <p><%= address.country %>, <%= address.postalCode %></p>
                                <p>Phone: <%= address.phone %></p>
                            </div>
                        <% }); %>
                    </div>
                    <button class="btn" onclick="showAddressModal()">
                        <i class="fas fa-plus"></i>
                        Add New Address
                    </button>
                </div>

                <!-- Payment Section -->
                <div class="checkout-section" id="paymentSection">
                    <h2>Payment Method</h2>
                    <div class="payment-options">
                        <div class="payment-option" onclick="togglePayment(this)">
                            <label>
                                <input type="radio" name="payment" value="cod">
                                <i class="fas fa-money-bill-wave"></i>
                                Cash on Delivery
                            </label>
                        </div>
                        
                        <div class="payment-option" onclick="togglePayment(this)">
                            <label>
                                <input type="radio" name="payment" value="card">
                                <i class="fas fa-credit-card"></i>
                                Credit/Debit Card
                            </label>
                            <div class="payment-fields">
                                <input type="text" placeholder="Card Number" class="form-input full-width">
                                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                    <input type="text" placeholder="MM/YY" class="form-input half-width">
                                    <input type="text" placeholder="CVV" class="form-input half-width">
                                </div>
                            </div>
                        </div>

                        <div class="payment-option" onclick="togglePayment(this)">
                            <label>
                                <input type="radio" name="payment" value="upi">
                                <i class="fas fa-mobile-alt"></i>
                                UPI Payment
                            </label>
                            <div class="payment-fields">
                                <input type="text" placeholder="UPI ID" class="form-input full-width">
                            </div>
                        </div>
                    </div>

                    <!-- Add error message and action buttons -->
                    <div class="payment-error" id="paymentError">
                        Please select a payment method
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="checkout-right">
                <div class="checkout-section" id="orderSummary">
                    <h2>Order Summary</h2>
                    <div class="order-items">
                        <% products.forEach(product => { %>
                            <div class="order-item">
                                <div class="product-image-container">
                                    <img src="<%= product.image0 %>" class="product-image" alt="<%= product.name %>">
                                </div>
                                <div class="product-details">
                                    <div class="product-header">
                                        <h3 class="product-name"><%= product.name %></h3>
                                        <button class="delete-btn" onclick="removeProduct(this, '<%= product._id %>')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    <div class="product-specs">
                                        <span class="spec-item">
                                            <i class="fas fa-palette"></i>
                                            Color: <%= product.colors %>
                                        </span>
                                        <span class="current-price">₹<%= product.price %></span>
                                    </div>
                                    <div class="quantity-control">
                                        <button class="qty-btn minus" onclick="adjustQuantity(this, -1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="qty-display" 
                                        data-price="<%= product.price %>"
                                        data-product-id="<%= product._id %>"
                                        data-offer="<%= product.offer%>"><%=product.quantity%></span>
                                        <button class="qty-btn plus" onclick="adjustQuantity(this, 1,'<%= product.count %>')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="item-total-container">
                                        <span>Item Total:</span>
                                        <span class="item-total">₹<%= product.price %></span>
                                    </div>
                                   
                                        <div class="out-of-stock-message" style="display: none;">
                                            Out of stock - Remove this product to proceed
                                        </div>
                                   
                                </div>
                            </div>
                        <% }); %>
                    </div>
                    
                    <div class="price-breakdown">
                        <div class="summary-item">
                            <span>Subtotal (<span class="item-count"><%= products.length %></span> items)</span>
                            <span class="amount">₹<span class="subtotal-value"><%= subtotal %></span></span>
                        </div>
                        <div class="summary-item">
                            <span>Delivery Fee</span>
                            <span class="amount">₹<span class="delivery-fee"><%= deliveryFee %></span></span>
                        </div>
                        <div class="summary-item discount">
                            <span>Discount Applied</span>
                            <span class="amount">-₹<span class="discount-value"><%= discount %></span></span>
                        </div>
                        <div class="summary-item total">
                            <span>Total Amount</span>
                            <span class="amount">₹<span class="total-value"><%= total %></span></span>
                        </div>
                    </div>

                    <button class="btn full-width" onclick="placeOrder()">
                        <i class="fas fa-shopping-bag"></i>
                        Place Order
                    </button>
                </div>
            </div>
        </div>

        <!-- Address Modal -->
        <div class="add-address-modal" id="addressModal">
            <div class="modal-content">
                <h2>Add New Address</h2>
                <form id="addressForm" >
                    <div class="form-group">
                        <input type="text" name="street" placeholder="Street Address" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="city" placeholder="City" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="state" placeholder="State" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="country" placeholder="Country" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="postalCode" placeholder="Postal Code" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" name="phone" placeholder="Phone Number" class="form-input" required>
                    </div>
                    <div class="action-btns">
                        <button type="button" class="btn" onclick="closeAddressModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i>
                            Save Address
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let selectedAddressId = '<%= addresses[0]?.id %>'; // Initialize with first address ID

function selectAddress(element,adresss) {
    // Remove selection from all addresses
    document.querySelectorAll('.address-card').forEach(card => {
        card.classList.remove('selected-address');
    });
    
    // Add selection to clicked address
    element.classList.add('selected-address');
    
    // Update selected address ID
    selectedAddressId = adresss;
    console.log('Selected Address ID:', selectedAddressId); // For testing
}

// Modify edit function to handle correct address
function showEditModal(event, addressId) {
    event.stopPropagation(); // Prevent address selection when clicking edit
    // Your edit modal logic here, using addressId
    document.getElementById('addressModal').style.display = 'block';
}

	<!-- all js here -->
<!-- jquery latest version -->
<script>
	function filterProducts() {
    const selectedColors = Array.from(document.querySelectorAll('.color-option.selected'))
        .map(co => co.dataset.color.toLowerCase());

// Add these new functions
        function showEditModal() {
            // You can add logic to populate existing address data here
            document.getElementById('addressModal').style.display = 'block';
        }

        // Modified togglePayment function
        function togglePayment(option) {
    const allOptions = document.querySelectorAll('.payment-option');
    allOptions.forEach(opt => {
        opt.classList.remove('active');
        const fields = opt.querySelector('.payment-fields');
        if (fields) { // Add null check here
            fields.style.maxHeight = '0';
        }
    });
    
    option.classList.add('active');
    const fields = option.querySelector('.payment-fields');
    if (fields) { // Add null check here
        fields.style.maxHeight = fields.scrollHeight + 'px';
    }
    
    // Capture payment method
    selectedPaymentMethod = option.querySelector('input').value;
    document.getElementById('paymentError').style.display = 'none';
}
        // Update existing closeAddressModal function
        function closeAddressModal() {
            document.getElementById('addressModal').style.display = 'none';
            // Reset form if needed
            document.getElementById('addressForm').reset();
        }

        let currentSection = 'addressSection';

        function nextSection(nextId) {
    // Validate payment section before proceeding to review
    if (currentSection === 'paymentSection' && nextId === 'reviewSection') {
        const paymentSelected = document.querySelector('input[name="payment"]:checked');
        if (!paymentSelected) {
            document.getElementById('paymentError').style.display = 'block';
            return;
        }
    }

    document.getElementById(currentSection).classList.remove('active-section');
    document.getElementById(nextId).classList.add('active-section');
    updateProgress(nextId);
    currentSection = nextId;
    
    // Clear payment error when leaving section
    if (currentSection !== 'paymentSection') {
        document.getElementById('paymentError').style.display = 'none';
    }
}

function togglePayment(option) {
    const allOptions = document.querySelectorAll('.payment-option');
    allOptions.forEach(opt => {
        opt.classList.remove('active');
        opt.querySelector('.payment-fields').style.maxHeight = '0';
    });
    
    option.classList.add('active');
    const fields = option.querySelector('.payment-fields');
    fields.style.maxHeight = fields.scrollHeight + 'px';
    
    // Clear error when payment method is selected
    document.getElementById('paymentError').style.display = 'none';
}
function prevSection(prevId) {
    document.getElementById(currentSection).classList.remove('active-section');
    document.getElementById(prevId).classList.add('active-section');
    updateProgress(prevId);
    currentSection = prevId;
}

function updateProgress(sectionId) {
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
        step.classList.remove('active-step');
        if((sectionId === 'addressSection' && index === 0) ||
           (sectionId === 'paymentSection' && index === 1) ||
           (sectionId === 'reviewSection' && index === 2)) {
            step.classList.add('active-step');
        }
    });

function showAddressModal() {
    document.getElementById('addressModal').style.display = 'block';
}

function closeAddressModal() {
    document.getElementById('addressModal').style.display = 'none';
}
let selectedPaymentMethod = null;
function togglePayment(option) {
    const allOptions = document.querySelectorAll('.payment-option');
    allOptions.forEach(opt => opt.classList.remove('active'));
    option.classList.add('active');
    
    
    
    // Capture payment method
    selectedPaymentMethod = option.querySelector('input').value;
    document.getElementById('paymentError').style.display = 'none';
}

// Update the placeOrder function to collect product data including offers
async function placeOrder() {
    if (!selectedAddressId) {
        alert('Please select a delivery address!');
        return;
    }
    
    if (!selectedPaymentMethod) {
        document.getElementById('paymentError').style.display = 'block';
        return;
    }

    // Hide all out-of-stock messages first
    document.querySelectorAll('.out-of-stock-message').forEach(msg => {
        msg.style.display = 'none';
    });

    // Collect product data with offers
    const products = Array.from(document.querySelectorAll('.order-item')).map(item => {
        const qtyDisplay = item.querySelector('.qty-display');
      
        return {
            productId: qtyDisplay.dataset.productId,
            quantity: parseInt(qtyDisplay.textContent),
            price: parseFloat(qtyDisplay.dataset.price),
            offer: parseInt(qtyDisplay.dataset.offer || 0) 
            
            // Add offer from data attribute
        };
    });

    // Get totals
    const totalAmount = parseFloat(document.querySelector('.total-value').textContent);
    const subtotal = parseFloat(document.querySelector('.subtotal-value').textContent);
    const deliveryFee = parseFloat(document.querySelector('.delivery-fee').textContent);
    const discount = parseFloat(document.querySelector('.discount-value').textContent);

    try {
        const response = await fetch('/user/placeOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                addressId: selectedAddressId,
                paymentMethod: selectedPaymentMethod,
                products: products,
                totals: {
                    subtotal: subtotal,
                    delivery: deliveryFee,
                    discount: discount,
                    total: totalAmount
                }
            })
        });

        

        if (response.ok) {
            const html = await response.text();
            document.documentElement.innerHTML = html; // Assuming your success response includes a redirect URL
        } else {
            const result = await response.json();
            if (result.stockIssue) {
                // Show out-of-stock message for the specific product
                const productElement = document.querySelector(`[data-product-id="${result.productId}"]`);
                if (productElement) {
                    const outOfStockMessage = productElement.closest('.order-item').querySelector('.out-of-stock-message');
                    if (outOfStockMessage) {
                        outOfStockMessage.style.display = 'block';
                    }
                }
            } else {
                alert('Order failed: ' + (result.error || 'Unknown error'));
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to place order. Please try again.');
    }
}
function saveAddress(e) {
    e.preventDefault();
    closeAddressModal();
    // Add address saving logic here
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addressModal');
    if(event.target == modal) {
        closeAddressModal();
    }
}

document.getElementById('addressForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/user/adresss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
            credentials: 'include' // Include cookies for session
        });

        const result = await response.json();
        
        if (result.success) {
            // Add the new address to the DOM
            const addressContainer = document.querySelector('#addressSection');
            const newAddress = createAddressElement(result.address);
            addressContainer.insertBefore(newAddress, addressContainer.querySelector('.btn'));
            closeAddressModal();
        } else {
            alert('Error adding address: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to add address. Please try again.');
    }
});
function createAddressElement(address) {
    const div = document.createElement('div');
    div.className = 'address-card';
    div.dataset.addressId = address.id;
    div.innerHTML = `
        <i class="fas fa-edit edit-icon" onclick="showEditModal(event, '${address.id}')"></i>
        <h3>${address.street}</h3>
        <p>${address.city}, ${address.state}</p>
        <p>${address.country}, ${address.postalCode}</p>
        <p>Phone: ${address.phone}</p>
    `;
    div.onclick = () => selectAddress(div);
    return div;
}
function adjustQuantity(button, change,max) {
    console.log(typeof max);
    
    
    const qtyDisplay = button.parentElement.querySelector('.qty-display');
    const currentQty = parseInt(qtyDisplay.textContent);
    if(max){
        if(parseInt(max)<=currentQty || currentQty>=5){
        return
    }
    }
    const newQty = Math.max(1, currentQty + change); // Ensure minimum is 1
    qtyDisplay.textContent = newQty;
    updateQuantity(qtyDisplay);
}

function updateQuantity(element) {
    const price = parseFloat(element.dataset.price);
    const quantity = parseInt(element.textContent);
    const itemTotal = element.parentElement.parentElement.querySelector('.item-total');
    const total = price * quantity;
    // Format number to remove .00
    itemTotal.textContent = '₹' + (total % 1 === 0 ? total : total.toFixed(2));
    
    updateOrderSummary();
}

function updateOrderSummary() {
    let subtotal = 0;
    document.querySelectorAll('.qty-display').forEach(display => {
        subtotal += parseFloat(display.dataset.price) * parseInt(display.textContent);
    });

    // Update displayed values with formatted numbers
    const subtotalElement = document.querySelector('.subtotal-value');
    subtotalElement.textContent = subtotal % 1 === 0 ? subtotal : subtotal.toFixed(2);
    
    // Get values from server-side variables
    const deliveryFee = parseFloat(document.querySelector('.delivery-fee').textContent);
    const discount = parseFloat(document.querySelector('.discount-value').textContent);
    
    // Calculate total
    const total = subtotal + deliveryFee - discount;
    const totalElement = document.querySelector('.total-value');
    totalElement.textContent = total % 1 === 0 ? total : total.toFixed(2);
}

function removeProduct(button, productId) {
    const orderItem = button.closest('.order-item');
    orderItem.classList.add('removing');

    // Wait for animation
    setTimeout(() => {
        // Remove the item from DOM
        orderItem.remove();
        
        // Update order summary
        updateOrderSummary();

        // Update item count
        const itemCountElement = document.querySelector('.item-count');
        const currentCount = parseInt(itemCountElement.textContent);
        itemCountElement.textContent = currentCount - 1;

        // If this was the last item, redirect to cart
        if (currentCount - 1 === 0) {
            window.location.href = '/cart';
        }
    }, 300);
}
    </script>
</body>
</html>
